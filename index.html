<!doctype html>
<html lang="vi">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Unit 5: Cities and Education in the future</title>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    html {
      height: 100%;
    }
    .flashcard {
      perspective: 1000px;
      width: 100%;
      max-width: 500px;
      height: 250px;
      margin: 0 auto;
    }
    @media (max-width: 768px) {
      .flashcard {
        height: 200px;
        max-width: 100%;
      }
    }
    .flashcard-inner {
      position: relative;
      width: 100%;
      height: 100%;
      transition: transform 0.6s;
      transform-style: preserve-3d;
    }
    .flashcard.flipped .flashcard-inner {
      transform: rotateY(180deg);
    }
    .flashcard-front, .flashcard-back {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      text-align: center;
    }
    @media (max-width: 768px) {
      .flashcard-front, .flashcard-back {
        padding: 10px;
      }
    }
    .flashcard-back {
      transform: rotateY(180deg);
    }
    .highlight {
      background-color: #fef08a;
      padding: 2px 4px;
      border-radius: 2px;
    }
    .progress-ring {
      transform: rotate(-90deg);
    }
    .progress-ring-circle {
      transition: stroke-dashoffset 0.35s;
    }
    .mobile-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1rem;
    }
    @media (max-width: 640px) {
      .mobile-grid {
        grid-template-columns: 1fr;
        gap: 0.75rem;
      }
    }
    .mobile-tabs {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      justify-content: center;
    }
    @media (max-width: 640px) {
      .mobile-tabs {
        flex-direction: column;
        gap: 0.5rem;
      }
      .mobile-tabs button {
        width: 100%;
      }
    }
    .mobile-progress {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 1rem;
    }
    @media (max-width: 640px) {
      .mobile-progress {
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
      }
    }
    .mobile-city-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
    }
    @media (max-width: 640px) {
      .mobile-city-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
      }
    }
    .mobile-dish-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem;
      border-radius: 0.5rem;
      margin-bottom: 0.5rem;
    }
    @media (max-width: 640px) {
      .mobile-dish-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }
      .mobile-dish-info {
        width: 100%;
      }
      .mobile-dish-button {
        align-self: flex-end;
      }
    }
    .mobile-nav-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 1.5rem;
      gap: 1rem;
    }
    @media (max-width: 640px) {
      .mobile-nav-controls {
        flex-direction: column;
        gap: 1rem;
      }
      .mobile-nav-buttons {
        display: flex;
        justify-content: space-between;
        width: 100%;
        gap: 1rem;
      }
      .mobile-nav-buttons button {
        flex: 1;
      }
    }
    .mobile-reading-text {
      line-height: 1.8;
      margin-bottom: 1.5rem;
    }
    @media (max-width: 640px) {
      .mobile-reading-text {
        line-height: 1.6;
        font-size: 0.95em;
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body>
  <div id="app" class="min-h-full flex flex-col"></div>
  <script>
    const defaultConfig = {
      unit_title: "Unit 5: Cities and Education in the future",
      vocabulary_tab: "Từ vựng",
      reading_tab: "Bài đọc",
      grammar_tab: "Ngữ pháp",
      background_color: "#f0f9ff",
      card_color: "#ffffff",
      primary_color: "#3b82f6",
      text_color: "#1e293b",
      accent_color: "#10b981",
      font_family: "Segoe UI",
      font_size: 16
    };

    const vocabularyData = [
      {
        word: "3D Digi book",
        ipa: "/θriː diː ˈdɪdʒɪ bʊk/",
        type: "noun",
        meaning: "sách kỹ thuật số 3D",
        example: "Students will use 3D Digi books for interactive learning."
      },
      {
        word: "3D printed house",
        ipa: "/θriː diː ˈprɪntɪd haʊs/",
        type: "noun",
        meaning: "nhà in 3D",
        example: "3D printed houses will solve housing problems in the future."
      },
      {
        word: "Appropriate",
        ipa: "/əˈprəʊpriət/",
        type: "adjective",
        meaning: "phù hợp, thích hợp",
        example: "We need appropriate technology for sustainable cities."
      },
      {
        word: "Break down",
        ipa: "/breɪk daʊn/",
        type: "phrasal verb",
        meaning: "hỏng hóc, phân tích",
        example: "The old system will break down without proper maintenance."
      },
      {
        word: "Break up",
        ipa: "/breɪk ʌp/",
        type: "phrasal verb",
        meaning: "chia tách, tan vỡ",
        example: "Traffic jams will break up with smart transportation."
      },
      {
        word: "Charge",
        ipa: "/tʃɑːdʒ/",
        type: "verb/noun",
        meaning: "sạc điện, tính phí",
        example: "Electric vehicles need to charge at charging stations."
      },
      {
        word: "Cyborg",
        ipa: "/ˈsaɪbɔːɡ/",
        type: "noun",
        meaning: "người máy, cyborg",
        example: "Cyborgs might help humans in dangerous jobs."
      },
      {
        word: "Data",
        ipa: "/ˈdeɪtə/",
        type: "noun",
        meaning: "dữ liệu",
        example: "Smart cities collect data to improve services."
      },
      {
        word: "Deliver",
        ipa: "/dɪˈlɪvər/",
        type: "verb",
        meaning: "giao hàng, phân phối",
        example: "Drones will deliver packages to your door."
      },
      {
        word: "Digital road",
        ipa: "/ˈdɪdʒɪtl rəʊd/",
        type: "noun",
        meaning: "đường kỹ thuật số",
        example: "Digital roads will guide autonomous vehicles safely."
      },
      {
        word: "Driverless",
        ipa: "/ˈdraɪvərləs/",
        type: "adjective",
        meaning: "không người lái",
        example: "Driverless cars will reduce traffic accidents."
      },
      {
        word: "Drone delivery",
        ipa: "/drəʊn dɪˈlɪvəri/",
        type: "noun",
        meaning: "giao hàng bằng máy bay không người lái",
        example: "Drone delivery will make shipping faster and cheaper."
      },
      {
        word: "Engine",
        ipa: "/ˈendʒɪn/",
        type: "noun",
        meaning: "động cơ",
        example: "Electric engines are more environmentally friendly."
      },
      {
        word: "Exchange",
        ipa: "/ɪksˈtʃeɪndʒ/",
        type: "verb/noun",
        meaning: "trao đổi, giao dịch",
        example: "People will exchange ideas through virtual reality."
      },
      {
        word: "Floating building",
        ipa: "/ˈfləʊtɪŋ ˈbɪldɪŋ/",
        type: "noun",
        meaning: "tòa nhà nổi",
        example: "Floating buildings will help cities adapt to rising sea levels."
      },
      {
        word: "Flying vehicles",
        ipa: "/ˈflaɪɪŋ ˈviːɪklz/",
        type: "noun",
        meaning: "phương tiện bay",
        example: "Flying vehicles will solve traffic congestion problems."
      },
      {
        word: "Foldable",
        ipa: "/ˈfəʊldəbl/",
        type: "adjective",
        meaning: "có thể gập lại",
        example: "Foldable phones are becoming more popular."
      },
      {
        word: "Hologram device",
        ipa: "/ˈhɒləɡræm dɪˈvaɪs/",
        type: "noun",
        meaning: "thiết bị hologram",
        example: "Hologram devices will make virtual meetings more realistic."
      },
      {
        word: "Home schooling",
        ipa: "/həʊm ˈskuːlɪŋ/",
        type: "noun",
        meaning: "giáo dục tại nhà",
        example: "Home schooling will become more common with advanced technology."
      },
      {
        word: "Measure",
        ipa: "/ˈmeʒər/",
        type: "verb/noun",
        meaning: "đo lường, biện pháp",
        example: "Smart sensors will measure air quality in real time."
      },
      {
        word: "Motorway",
        ipa: "/ˈməʊtəweɪ/",
        type: "noun",
        meaning: "đường cao tốc",
        example: "Smart motorways will optimize traffic flow automatically."
      },
      {
        word: "Moving walkway",
        ipa: "/ˈmuːvɪŋ ˈwɔːkweɪ/",
        type: "noun",
        meaning: "thang cuốn ngang",
        example: "Moving walkways will help people travel faster in cities."
      },
      {
        word: "Possibility",
        ipa: "/ˌpɒsəˈbɪləti/",
        type: "noun",
        meaning: "khả năng, có thể",
        example: "There's a possibility of living on Mars in the future."
      },
      {
        word: "Prediction",
        ipa: "/prɪˈdɪkʃn/",
        type: "noun",
        meaning: "dự đoán",
        example: "AI will make accurate predictions about weather patterns."
      },
      {
        word: "Sensor",
        ipa: "/ˈsensər/",
        type: "noun",
        meaning: "cảm biến",
        example: "Sensors will monitor everything in smart cities."
      },
      {
        word: "Skybridge",
        ipa: "/ˈskaɪbrɪdʒ/",
        type: "noun",
        meaning: "cầu vượt trên không",
        example: "Skybridges will connect tall buildings in future cities."
      },
      {
        word: "Smart mirror",
        ipa: "/smɑːt ˈmɪrər/",
        type: "noun",
        meaning: "gương thông minh",
        example: "Smart mirrors will display weather and news while you get ready."
      },
      {
        word: "Socialise",
        ipa: "/ˈsəʊʃəlaɪz/",
        type: "verb",
        meaning: "giao tiếp xã hội",
        example: "People will socialise through virtual reality platforms."
      },
      {
        word: "Solar window",
        ipa: "/ˈsəʊlər ˈwɪndəʊ/",
        type: "noun",
        meaning: "cửa sổ năng lượng mặt trời",
        example: "Solar windows will generate electricity while letting light in."
      },
      {
        word: "Technician",
        ipa: "/tekˈnɪʃn/",
        type: "noun",
        meaning: "kỹ thuật viên",
        example: "Robot technicians will maintain smart city systems."
      },
      {
        word: "Underground motorway",
        ipa: "/ˌʌndəɡraʊnd ˈməʊtəweɪ/",
        type: "noun",
        meaning: "đường cao tốc ngầm",
        example: "Underground motorways will save space in crowded cities."
      },
      {
        word: "Vacuum tube train",
        ipa: "/ˈvækjuːm tjuːb treɪn/",
        type: "noun",
        meaning: "tàu ống chân không",
        example: "Vacuum tube trains will travel at incredible speeds."
      },
      {
        word: "Valuable",
        ipa: "/ˈvæljuəbl/",
        type: "adjective",
        meaning: "có giá trị",
        example: "Clean air will become more valuable in future cities."
      },
      {
        word: "Vertical farm",
        ipa: "/ˈvɜːtɪkl fɑːm/",
        type: "noun",
        meaning: "nông trại thẳng đứng",
        example: "Vertical farms will grow food in tall buildings."
      },
      {
        word: "Virtual reality headset",
        ipa: "/ˈvɜːtʃuəl riˈæləti ˈhedset/",
        type: "noun",
        meaning: "kính thực tế ảo",
        example: "Virtual reality headsets will transform how we learn and work."
      },
      {
        word: "Walkway",
        ipa: "/ˈwɔːkweɪ/",
        type: "noun",
        meaning: "lối đi bộ",
        example: "Covered walkways will protect pedestrians from weather."
      }
    ];

    const readingText = `Future cities will feature revolutionary technologies that transform how we live and learn. <span class="highlight">3D printed houses</span> will provide affordable housing solutions, while <span class="highlight">floating buildings</span> help cities adapt to climate change. <span class="highlight">Driverless</span> vehicles and <span class="highlight">flying vehicles</span> will navigate through <span class="highlight">digital roads</span>, reducing traffic congestion significantly.

Education will embrace cutting-edge innovations like <span class="highlight">3D Digi books</span> and <span class="highlight">virtual reality headsets</span> for immersive learning experiences. Students will attend classes using <span class="highlight">hologram devices</span>, making distance learning more interactive. <span class="highlight">Home schooling</span> will become mainstream as technology makes quality education accessible everywhere.

Smart infrastructure will include <span class="highlight">solar windows</span> that generate clean energy, <span class="highlight">vertical farms</span> growing food in urban spaces, and <span class="highlight">moving walkways</span> connecting buildings via <span class="highlight">skybridges</span>. <span class="highlight">Sensors</span> will continuously <span class="highlight">measure</span> air quality and traffic flow. <span class="highlight">Drone delivery</span> services will transport goods efficiently, while <span class="highlight">cyborgs</span> and <span class="highlight">technicians</span> maintain city systems. These <span class="highlight">valuable</span> innovations represent the <span class="highlight">possibility</span> of creating sustainable, intelligent communities. Such <span class="highlight">predictions</span> suggest cities will become more <span class="highlight">appropriate</span> for human needs, where people can <span class="highlight">socialise</span> and <span class="highlight">exchange</span> ideas in harmony with advanced technology.`;

    const readingQuestions = [
      {
        question: "What will help cities adapt to climate change?",
        options: ["3D printed houses", "Floating buildings", "Digital roads", "Moving walkways"],
        correct: 1
      },
      {
        question: "What will make distance learning more interactive?",
        options: ["Traditional books", "Hologram devices", "Regular computers", "Paper worksheets"],
        correct: 1
      },
      {
        question: "What will generate clean energy in future buildings?",
        options: ["Regular windows", "Solar windows", "Glass doors", "Metal panels"],
        correct: 1
      },
      {
        question: "Who will maintain smart city systems?",
        options: ["Only humans", "Cyborgs and technicians", "Robots only", "Students"],
        correct: 1
      },
      {
        question: "What will continuously measure air quality and traffic flow?",
        options: ["Cameras", "Computers", "Sensors", "Drones"],
        correct: 2
      }
    ];

    const grammarTopics = [
      {
        title: "Tương lai đơn (Simple Future)",
        content: `<h3 class="font-bold mb-2">Cấu trúc:</h3>
<p class="mb-2">Khẳng định: S + will + V(infinitive)</p>
<p class="mb-2">Phủ định: S + will not (won't) + V(infinitive)</p>
<p class="mb-4">Nghi vấn: Will + S + V(infinitive)?</p>
<h3 class="font-bold mb-2">Cách dùng:</h3>
<ul class="list-disc ml-6 mb-2">
<li>Dự đoán về tương lai</li>
<li>Quyết định tức thời</li>
<li>Lời hứa, đề nghị</li>
</ul>
<h3 class="font-bold mb-2">Ví dụ:</h3>
<p class="mb-1">- Cities will be more sustainable in the future.</p>
<p class="mb-1">- I will help you with your homework.</p>
<p>- Will technology change education?</p>`
      },
      {
        title: "Tương lai gần (Near Future)",
        content: `<h3 class="font-bold mb-2">Cấu trúc:</h3>
<p class="mb-2">Khẳng định: S + am/is/are + going to + V(infinitive)</p>
<p class="mb-2">Phủ định: S + am/is/are + not + going to + V(infinitive)</p>
<p class="mb-4">Nghi vấn: Am/Is/Are + S + going to + V(infinitive)?</p>
<h3 class="font-bold mb-2">Cách dùng:</h3>
<ul class="list-disc ml-6 mb-2">
<li>Dự định, kế hoạch đã có</li>
<li>Dự đoán có căn cứ</li>
</ul>
<h3 class="font-bold mb-2">Ví dụ:</h3>
<p class="mb-1">- We are going to build a new school next year.</p>
<p class="mb-1">- Look at those clouds! It's going to rain.</p>
<p>- Are you going to study abroad?</p>`
      },
      {
        title: "Trạng từ chỉ mức độ chắc chắn (Adverbs of Certainty)",
        content: `<h3 class="font-bold mb-2">Các trạng từ phổ biến:</h3>
<ul class="list-disc ml-6 mb-4">
<li><strong>Certainly, definitely</strong> (100% chắc chắn)</li>
<li><strong>Probably</strong> (khoảng 80% chắc chắn)</li>
<li><strong>Perhaps, maybe, possibly</strong> (khoảng 50% chắc chắn)</li>
</ul>
<h3 class="font-bold mb-2">Vị trí:</h3>
<p class="mb-4">Thường đứng trước động từ chính, sau động từ "to be"</p>
<h3 class="font-bold mb-2">Ví dụ:</h3>
<p class="mb-1">- Cities will definitely be smarter in the future.</p>
<p class="mb-1">- Education will probably change dramatically.</p>
<p class="mb-1">- We will perhaps use virtual reality in classrooms.</p>
<p>- Technology is certainly important for learning.</p>`
      }
    ];

    // Generate vocabulary quiz questions
    const vocabularyQuizzes = vocabularyData.map((vocab, index) => {
      // Create wrong options by mixing meanings from other words
      const wrongMeanings = vocabularyData
        .filter((_, i) => i !== index)
        .map(v => v.meaning)
        .sort(() => Math.random() - 0.5)
        .slice(0, 3);
      
      const options = [vocab.meaning, ...wrongMeanings].sort(() => Math.random() - 0.5);
      const correctIndex = options.indexOf(vocab.meaning);
      
      return {
        question: `What does "${vocab.word}" mean?`,
        options: options,
        correct: correctIndex
      };
    });

    const citiesData = [
      {
        name: "Tokyo",
        country: "Japan",
        icon: "🗼",
        flag: "🇯🇵",
        dishes: [
          { name: "Sushi", pronunciation: "soo-shee", icon: "🍣" },
          { name: "Ramen", pronunciation: "rah-men", icon: "🍜" },
          { name: "Tempura", pronunciation: "tem-poo-rah", icon: "🍤" }
        ],
        description: "Tokyo is famous for its fresh seafood and traditional Japanese cuisine."
      },
      {
        name: "Paris",
        country: "France", 
        icon: "🗼",
        flag: "🇫🇷",
        dishes: [
          { name: "Croissant", pronunciation: "krwah-sahn", icon: "🥐" },
          { name: "Escargot", pronunciation: "es-kar-goh", icon: "🐌" },
          { name: "Macarons", pronunciation: "mah-kah-rohn", icon: "🧁" }
        ],
        description: "Paris is renowned for its elegant pastries and sophisticated French cuisine."
      },
      {
        name: "Bangkok",
        country: "Thailand",
        icon: "🛕",
        flag: "🇹🇭",
        dishes: [
          { name: "Pad Thai", pronunciation: "pad-tie", icon: "🍝" },
          { name: "Tom Yum", pronunciation: "tom-yum", icon: "🍲" },
          { name: "Mango Sticky Rice", pronunciation: "man-go stick-ee rice", icon: "🥭" }
        ],
        description: "Bangkok offers vibrant street food and authentic Thai flavors."
      },
      {
        name: "Istanbul",
        country: "Turkey",
        icon: "🕌",
        flag: "🇹🇷",
        dishes: [
          { name: "Kebab", pronunciation: "keh-bob", icon: "🥙" },
          { name: "Baklava", pronunciation: "bah-klah-vah", icon: "🍯" },
          { name: "Turkish Delight", pronunciation: "tur-kish dee-lite", icon: "🍬" }
        ],
        description: "Istanbul blends European and Asian culinary traditions beautifully."
      },
      {
        name: "Mumbai",
        country: "India",
        icon: "🏛️",
        flag: "🇮🇳",
        dishes: [
          { name: "Vada Pav", pronunciation: "vah-dah pahv", icon: "🥪" },
          { name: "Biryani", pronunciation: "beer-yah-nee", icon: "🍛" },
          { name: "Samosa", pronunciation: "sah-moh-sah", icon: "🥟" }
        ],
        description: "Mumbai is famous for its spicy street food and diverse Indian cuisine."
      },
      {
        name: "Mexico City",
        country: "Mexico",
        icon: "🏺",
        flag: "🇲🇽",
        dishes: [
          { name: "Tacos", pronunciation: "tah-kohs", icon: "🌮" },
          { name: "Quesadilla", pronunciation: "keh-sah-dee-yah", icon: "🫓" },
          { name: "Churros", pronunciation: "choo-rohs", icon: "🍩" }
        ],
        description: "Mexico City offers authentic Mexican flavors and traditional recipes."
      }
    ];

    const grammarExercises = [
      { question: "Cities _____ more sustainable in 2050.", options: ["will be", "is", "are", "was"], correct: 0 },
      { question: "We _____ going to visit the smart city next month.", options: ["will", "are", "is", "be"], correct: 1 },
      { question: "Technology will _____ change education.", options: ["probable", "definitely", "may", "perhaps"], correct: 1 },
      { question: "_____ you help me with this project?", options: ["Are", "Do", "Will", "Is"], correct: 2 },
      { question: "She _____ going to study renewable energy.", options: ["will", "is", "are", "be"], correct: 1 },
      { question: "Students will _____ learn online in the future.", options: ["probable", "certainly", "maybe", "perhaps"], correct: 1 },
      { question: "I think it _____ rain tomorrow.", options: ["will", "is going", "going to", "are"], correct: 0 },
      { question: "They _____ build a new school next year.", options: ["will going to", "are going to", "will to", "going"], correct: 1 },
      { question: "Education will _____ be more interactive.", options: ["probable", "probably", "may", "might"], correct: 1 },
      { question: "_____ we have virtual classrooms soon?", options: ["Are", "Do", "Will", "Is"], correct: 2 },
      { question: "The city _____ use renewable energy sources.", options: ["will", "is going", "going to", "are"], correct: 0 },
      { question: "I _____ going to learn about sustainable cities.", options: ["will", "am", "are", "be"], correct: 1 },
      { question: "Automation will _____ change how we work.", options: ["certain", "certainly", "may", "might"], correct: 1 },
      { question: "_____ they going to implement new technology?", options: ["Will", "Do", "Are", "Is"], correct: 2 },
      { question: "Future cities _____ be very different.", options: ["will", "is going to", "are going", "going"], correct: 0 },
      { question: "We _____ probably see flying cars in the future.", options: ["are", "will", "is", "be"], correct: 1 },
      { question: "She _____ going to become an engineer.", options: ["will", "is", "are", "be"], correct: 1 },
      { question: "Teachers will _____ use AI in classrooms.", options: ["definite", "definitely", "may", "might"], correct: 1 },
      { question: "_____ you going to attend the conference?", options: ["Will", "Do", "Are", "Is"], correct: 2 },
      { question: "Infrastructure _____ improve significantly.", options: ["will", "is going", "going to", "are"], correct: 0 },
      { question: "I _____ going to research smart cities.", options: ["will", "am", "are", "be"], correct: 1 },
      { question: "Technology will _____ transform education.", options: ["certain", "certainly", "may", "might"], correct: 1 },
      { question: "_____ robots teach in future schools?", options: ["Are", "Do", "Will", "Is"], correct: 2 },
      { question: "They _____ going to create sustainable solutions.", options: ["will", "are", "is", "be"], correct: 1 },
      { question: "Cities will _____ be more efficient.", options: ["probable", "probably", "may", "might"], correct: 1 },
      { question: "I _____ study environmental science next year.", options: ["will", "am going", "going to", "are"], correct: 0 },
      { question: "We _____ going to use virtual reality for learning.", options: ["will", "are", "is", "be"], correct: 1 },
      { question: "Innovation will _____ drive progress.", options: ["certain", "certainly", "may", "might"], correct: 1 },
      { question: "_____ education be free for everyone in the future?", options: ["Are", "Do", "Will", "Is"], correct: 2 },
      { question: "The environment _____ be protected by new policies.", options: ["will", "is going", "going to", "are"], correct: 0 }
    ];

    let currentTab = 'vocabulary';
    let currentVocabIndex = 0;
    let isFlipped = false;
    let currentReadingAnswer = Array(5).fill(null);
    let currentGrammarTopic = null;
    let currentExerciseAnswers = Array(30).fill(null);
    let progressData = { vocabulary: 0, reading: 0, grammar: 0 };
    let vocabularyMode = 'learn'; // 'learn' or 'quiz'
    let currentVocabQuizAnswers = Array(36).fill(null);


    const dataHandler = {
      onDataChanged(data) {
        if (data.length > 0) {
          const latest = data[data.length - 1];
          progressData.vocabulary = latest.vocabulary_progress || 0;
          progressData.reading = latest.reading_progress || 0;
          progressData.grammar = latest.grammar_progress || 0;
        }
        render();
      }
    };

    function calculateOverallProgress() {
      return Math.round((progressData.vocabulary + progressData.reading + progressData.grammar) / 3);
    }

    function createProgressRing(percentage, size = 80, color = null) {
      const radius = (size - 8) / 2;
      const circumference = 2 * Math.PI * radius;
      const offset = circumference - (percentage / 100) * circumference;
      const strokeColor = color || (defaultConfig.primary_color || '#3b82f6');
      
      return `
        <div class="relative inline-flex items-center justify-center">
          <svg class="progress-ring" width="${size}" height="${size}">
            <circle class="progress-ring-circle" stroke="#f3f4f6" stroke-width="8" fill="transparent" r="${radius}" cx="${size/2}" cy="${size/2}"/>
            <circle class="progress-ring-circle" stroke="${strokeColor}" stroke-width="8" fill="transparent" r="${radius}" cx="${size/2}" cy="${size/2}" 
              style="stroke-dasharray: ${circumference}; stroke-dashoffset: ${offset}; stroke-linecap: round;"/>
          </svg>
          <div class="absolute inset-0 flex flex-col items-center justify-center">
            <span class="font-bold" style="font-size: ${size/5}px; color: ${strokeColor};">${percentage}</span>
            <span class="text-xs" style="font-size: ${size/8}px; color: ${strokeColor}; opacity: 0.8;">%</span>
          </div>
        </div>
      `;
    }

    function playCorrectSound() {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      oscillator.frequency.value = 800;
      oscillator.type = 'sine';
      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
      
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.3);
    }

    function playIncorrectSound() {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      oscillator.frequency.value = 200;
      oscillator.type = 'sawtooth';
      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
      
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.5);
    }

    function speakWord(text) {
      if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'en-US';
        utterance.rate = 0.9;
        window.speechSynthesis.speak(utterance);
      }
    }

    function speakDish(dishName) {
      if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(dishName);
        utterance.lang = 'en-US';
        utterance.rate = 0.8;
        window.speechSynthesis.speak(utterance);
      }
    }

    function nextVocab() {
      if (currentVocabIndex < vocabularyData.length - 1) {
        currentVocabIndex++;
        isFlipped = false;
        speakWord(vocabularyData[currentVocabIndex].word);
        updateProgress('vocabulary', ((currentVocabIndex + 1) / vocabularyData.length) * 100);
        render();
      }
    }

    function prevVocab() {
      if (currentVocabIndex > 0) {
        currentVocabIndex--;
        isFlipped = false;
        speakWord(vocabularyData[currentVocabIndex].word);
        render();
      }
    }

    function flipCard() {
      isFlipped = !isFlipped;
      render();
    }

    function checkReadingAnswer(questionIndex, selectedOption) {
      currentReadingAnswer[questionIndex] = selectedOption;
      const isCorrect = selectedOption === readingQuestions[questionIndex].correct;
      
      if (isCorrect) {
        playCorrectSound();
      } else {
        playIncorrectSound();
      }
      
      const correctCount = currentReadingAnswer.filter((ans, idx) => ans === readingQuestions[idx].correct).length;
      updateProgress('reading', (correctCount / readingQuestions.length) * 100);
      render();
    }

    function checkGrammarAnswer(questionIndex, selectedOption) {
      currentExerciseAnswers[questionIndex] = selectedOption;
      const isCorrect = selectedOption === grammarExercises[questionIndex].correct;
      
      if (isCorrect) {
        playCorrectSound();
      } else {
        playIncorrectSound();
      }
      
      const correctCount = currentExerciseAnswers.filter((ans, idx) => ans === grammarExercises[idx].correct).length;
      updateProgress('grammar', (correctCount / grammarExercises.length) * 100);
      render();
    }

    function checkVocabQuizAnswer(questionIndex, selectedOption) {
      currentVocabQuizAnswers[questionIndex] = selectedOption;
      const isCorrect = selectedOption === vocabularyQuizzes[questionIndex].correct;
      
      if (isCorrect) {
        playCorrectSound();
      } else {
        playIncorrectSound();
      }
      
      const correctCount = currentVocabQuizAnswers.filter((ans, idx) => ans === vocabularyQuizzes[idx].correct).length;
      updateProgress('vocabulary', (correctCount / vocabularyQuizzes.length) * 100);
      render();
    }

    async function updateProgress(type, value) {
      progressData[type] = Math.round(value);
      
      if (window.dataSdk && window.dataSdk.config !== undefined) {
        const result = await window.dataSdk.create({
          vocabulary_progress: progressData.vocabulary,
          reading_progress: progressData.reading,
          grammar_progress: progressData.grammar,
          completed_exercises: new Date().toISOString()
        });
      }
    }

    function render() {
      const config = window.elementSdk ? window.elementSdk.config : defaultConfig;
      const customFont = config.font_family || defaultConfig.font_family;
      const baseSize = config.font_size || defaultConfig.font_size;
      const baseFontStack = 'Segoe UI, Tahoma, Geneva, Verdana, sans-serif';
      
      const app = document.getElementById('app');
      app.style.backgroundColor = config.background_color || defaultConfig.background_color;
      app.style.fontFamily = `${customFont}, ${baseFontStack}`;
      app.style.fontSize = `${baseSize}px`;
      app.style.color = config.text_color || defaultConfig.text_color;
      
      const overallProgress = calculateOverallProgress();
      
      let content = `
        <div class="w-full max-w-6xl mx-auto p-3 sm:p-4 md:p-6">
          <div class="mb-4 sm:mb-6">
            <a href="https://nckhthptnk.github.io/tienganh11/" target="_blank" rel="noopener noreferrer" 
               class="inline-flex items-center px-3 sm:px-4 py-2 rounded-lg transition-colors mb-3 sm:mb-4 text-sm sm:text-base"
               style="background-color: ${config.primary_color || defaultConfig.primary_color}; color: white; font-size: ${baseSize * 0.9}px;">
              ← Quay về trang chủ
            </a>
            <h1 class="font-bold mb-4 sm:mb-6 text-center px-2" style="font-size: ${baseSize * 1.5}px; color: ${config.text_color || defaultConfig.text_color};">
              ${config.unit_title || defaultConfig.unit_title}
            </h1>
            
            <div class="rounded-lg p-4 sm:p-6 mb-4 sm:mb-6" style="background-color: ${config.card_color || defaultConfig.card_color}; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
              <h2 class="font-bold mb-3 sm:mb-4 text-center sm:text-left" style="font-size: ${baseSize * 1.2}px;">Tiến độ học tập</h2>
              <div class="mobile-progress">
                <div class="text-center">
                  <div class="flex justify-center mb-2">${createProgressRing(overallProgress, 80, config.primary_color || defaultConfig.primary_color)}</div>
                  <p style="font-size: ${baseSize * 0.85}px; font-weight: 600; color: ${config.primary_color || defaultConfig.primary_color};">Tổng thể</p>
                </div>
                <div class="text-center">
                  <div class="flex justify-center mb-2">${createProgressRing(progressData.vocabulary, 75, '#8b5cf6')}</div>
                  <p style="font-size: ${baseSize * 0.85}px; font-weight: 600; color: #8b5cf6;">Từ vựng</p>
                </div>
                <div class="text-center">
                  <div class="flex justify-center mb-2">${createProgressRing(progressData.reading, 75, '#f59e0b')}</div>
                  <p style="font-size: ${baseSize * 0.85}px; font-weight: 600; color: #f59e0b;">Bài đọc</p>
                </div>
                <div class="text-center">
                  <div class="flex justify-center mb-2">${createProgressRing(progressData.grammar, 75, config.accent_color || defaultConfig.accent_color)}</div>
                  <p style="font-size: ${baseSize * 0.85}px; font-weight: 600; color: ${config.accent_color || defaultConfig.accent_color};">Ngữ pháp</p>
                </div>
              </div>
            </div>
            
            <div class="mobile-tabs mb-4 sm:mb-6">
              <button onclick="switchTab('vocabulary')" class="px-4 sm:px-6 py-2 sm:py-3 rounded-lg font-semibold transition-colors text-sm sm:text-base" 
                style="background-color: ${currentTab === 'vocabulary' ? (config.primary_color || defaultConfig.primary_color) : '#e5e7eb'}; 
                       color: ${currentTab === 'vocabulary' ? 'white' : (config.text_color || defaultConfig.text_color)}; 
                       font-size: ${baseSize * 0.9}px;">
                ${config.vocabulary_tab || defaultConfig.vocabulary_tab}
              </button>
              <button onclick="switchTab('reading')" class="px-4 sm:px-6 py-2 sm:py-3 rounded-lg font-semibold transition-colors text-sm sm:text-base" 
                style="background-color: ${currentTab === 'reading' ? (config.primary_color || defaultConfig.primary_color) : '#e5e7eb'}; 
                       color: ${currentTab === 'reading' ? 'white' : (config.text_color || defaultConfig.text_color)}; 
                       font-size: ${baseSize * 0.9}px;">
                ${config.reading_tab || defaultConfig.reading_tab}
              </button>
              <button onclick="switchTab('grammar')" class="px-4 sm:px-6 py-2 sm:py-3 rounded-lg font-semibold transition-colors text-sm sm:text-base" 
                style="background-color: ${currentTab === 'grammar' ? (config.primary_color || defaultConfig.primary_color) : '#e5e7eb'}; 
                       color: ${currentTab === 'grammar' ? 'white' : (config.text_color || defaultConfig.text_color)}; 
                       font-size: ${baseSize * 0.9}px;">
                ${config.grammar_tab || defaultConfig.grammar_tab}
              </button>
              <button onclick="switchTab('cities')" class="px-4 sm:px-6 py-2 sm:py-3 rounded-lg font-semibold transition-colors text-sm sm:text-base" 
                style="background-color: ${currentTab === 'cities' ? (config.accent_color || defaultConfig.accent_color) : '#e5e7eb'}; 
                       color: ${currentTab === 'cities' ? 'white' : (config.text_color || defaultConfig.text_color)}; 
                       font-size: ${baseSize * 0.9}px;">
                🌍 Cities & Food
              </button>
            </div>
          </div>
      `;
      
      if (currentTab === 'vocabulary') {
        content += `
          <div class="rounded-lg p-4 sm:p-6" style="background-color: ${config.card_color || defaultConfig.card_color}; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div class="mobile-tabs mb-4 sm:mb-6">
              <button onclick="switchVocabularyMode('learn')" class="px-4 sm:px-6 py-2 sm:py-3 rounded-lg font-semibold transition-colors text-sm sm:text-base" 
                style="background-color: ${vocabularyMode === 'learn' ? (config.primary_color || defaultConfig.primary_color) : '#e5e7eb'}; 
                       color: ${vocabularyMode === 'learn' ? 'white' : (config.text_color || defaultConfig.text_color)}; 
                       font-size: ${baseSize * 0.9}px;">
                📚 Học từ vựng
              </button>
              <button onclick="switchVocabularyMode('quiz')" class="px-4 sm:px-6 py-2 sm:py-3 rounded-lg font-semibold transition-colors text-sm sm:text-base" 
                style="background-color: ${vocabularyMode === 'quiz' ? (config.accent_color || defaultConfig.accent_color) : '#e5e7eb'}; 
                       color: ${vocabularyMode === 'quiz' ? 'white' : (config.text_color || defaultConfig.text_color)}; 
                       font-size: ${baseSize * 0.9}px;">
                🧠 Kiểm tra trắc nghiệm
              </button>
            </div>
        `;

        if (vocabularyMode === 'learn') {
          const vocab = vocabularyData[currentVocabIndex];
          content += `
            <div class="flashcard ${isFlipped ? 'flipped' : ''}" onclick="flipCard()">
              <div class="flashcard-inner">
                <div class="flashcard-front" style="background-color: ${config.primary_color || defaultConfig.primary_color}; color: white;">
                  <h2 class="font-bold mb-2 sm:mb-4" style="font-size: ${baseSize * 1.8}px;">${vocab.word}</h2>
                  <p style="font-size: ${baseSize * 1}px; opacity: 0.9;">${vocab.ipa}</p>
                  <p class="mt-2 sm:mt-4 text-xs sm:text-sm" style="font-size: ${baseSize * 0.8}px; opacity: 0.8;">Nhấn Space hoặc click để lật</p>
                </div>
                <div class="flashcard-back" style="background-color: ${config.accent_color || defaultConfig.accent_color}; color: white;">
                  <p class="mb-1 sm:mb-2 text-xs sm:text-sm" style="font-size: ${baseSize * 0.8}px; opacity: 0.9;">${vocab.type}</p>
                  <h3 class="font-bold mb-2 sm:mb-4" style="font-size: ${baseSize * 1.3}px;">${vocab.meaning}</h3>
                  <p class="text-xs sm:text-sm" style="font-size: ${baseSize * 0.85}px; font-style: italic; line-height: 1.4;">"${vocab.example}"</p>
                </div>
              </div>
            </div>
            
            <div class="relative">
              <button onclick="prevVocab()" ${currentVocabIndex === 0 ? 'disabled' : ''} 
                class="absolute left-0 top-1/2 transform -translate-y-1/2 px-3 sm:px-4 py-2 rounded-lg font-semibold transition-colors text-sm sm:text-base" 
                style="background-color: ${currentVocabIndex === 0 ? '#d1d5db' : (config.primary_color || defaultConfig.primary_color)}; 
                       color: white; font-size: ${baseSize * 0.85}px;">
                ← Lùi
              </button>
              <div class="text-center py-2">
                <span style="font-size: ${baseSize * 0.9}px; font-weight: 600;">${currentVocabIndex + 1} / ${vocabularyData.length}</span>
              </div>
              <button onclick="nextVocab()" ${currentVocabIndex === vocabularyData.length - 1 ? 'disabled' : ''} 
                class="absolute right-0 top-1/2 transform -translate-y-1/2 px-3 sm:px-4 py-2 rounded-lg font-semibold transition-colors text-sm sm:text-base" 
                style="background-color: ${currentVocabIndex === vocabularyData.length - 1 ? '#d1d5db' : (config.primary_color || defaultConfig.primary_color)}; 
                       color: white; font-size: ${baseSize * 0.85}px;">
                Tiếp →
              </button>
            </div>
          `;
        } else if (vocabularyMode === 'quiz') {
          content += `
            <div class="space-y-4">
              <h3 class="font-bold mb-4" style="font-size: ${baseSize * 1.3}px;">Kiểm tra từ vựng (${vocabularyQuizzes.length} câu)</h3>
              ${vocabularyQuizzes.map((quiz, qIdx) => `
                <div class="p-4 rounded-lg" style="background-color: ${config.background_color || defaultConfig.background_color};">
                  <p class="font-semibold mb-3" style="font-size: ${baseSize}px;">${qIdx + 1}. ${quiz.question}</p>
                  ${quiz.options.map((opt, optIdx) => {
                    const isSelected = currentVocabQuizAnswers[qIdx] === optIdx;
                    const isCorrect = optIdx === quiz.correct;
                    const showResult = currentVocabQuizAnswers[qIdx] !== null;
                    let bgColor = config.card_color || defaultConfig.card_color;
                    if (showResult && isSelected && isCorrect) bgColor = config.accent_color || defaultConfig.accent_color;
                    if (showResult && isSelected && !isCorrect) bgColor = '#ef4444';
                    if (showResult && !isSelected && isCorrect) bgColor = config.accent_color || defaultConfig.accent_color;
                    
                    return `
                      <button onclick="checkVocabQuizAnswer(${qIdx}, ${optIdx})" 
                        class="w-full text-left p-3 rounded mb-2 transition-colors"
                        style="background-color: ${bgColor}; 
                               color: ${showResult && (isCorrect || isSelected) ? 'white' : (config.text_color || defaultConfig.text_color)}; 
                               font-size: ${baseSize * 0.9}px;
                               border: 2px solid ${isSelected ? (config.primary_color || defaultConfig.primary_color) : 'transparent'};">
                        ${opt}
                      </button>
                    `;
                  }).join('')}
                </div>
              `).join('')}
            </div>
          `;
        }
        
        content += `</div>`;
      } else if (currentTab === 'reading') {
        content += `
          <div class="rounded-lg p-4 sm:p-6 mb-4 sm:mb-6" style="background-color: ${config.card_color || defaultConfig.card_color}; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <h2 class="font-bold mb-3 sm:mb-4" style="font-size: ${baseSize * 1.3}px;">Bài đọc</h2>
            <div class="mobile-reading-text" style="font-size: ${baseSize * 0.95}px;">${readingText}</div>
            
            <h3 class="font-bold mb-3 sm:mb-4" style="font-size: ${baseSize * 1.2}px;">Câu hỏi trắc nghiệm</h3>
            ${readingQuestions.map((q, qIdx) => `
              <div class="mb-4 sm:mb-6 p-3 sm:p-4 rounded-lg" style="background-color: ${config.background_color || defaultConfig.background_color};">
                <p class="font-semibold mb-2 sm:mb-3" style="font-size: ${baseSize * 0.9}px;">${qIdx + 1}. ${q.question}</p>
                ${q.options.map((opt, optIdx) => {
                  const isSelected = currentReadingAnswer[qIdx] === optIdx;
                  const isCorrect = optIdx === q.correct;
                  const showResult = currentReadingAnswer[qIdx] !== null;
                  let bgColor = config.card_color || defaultConfig.card_color;
                  if (showResult && isSelected && isCorrect) bgColor = config.accent_color || defaultConfig.accent_color;
                  if (showResult && isSelected && !isCorrect) bgColor = '#ef4444';
                  if (showResult && !isSelected && isCorrect) bgColor = config.accent_color || defaultConfig.accent_color;
                  
                  return `
                    <button onclick="checkReadingAnswer(${qIdx}, ${optIdx})" 
                      class="w-full text-left p-2 sm:p-3 rounded mb-1 sm:mb-2 transition-colors text-sm sm:text-base"
                      style="background-color: ${bgColor}; 
                             color: ${showResult && (isCorrect || isSelected) ? 'white' : (config.text_color || defaultConfig.text_color)}; 
                             font-size: ${baseSize * 0.85}px;
                             border: 2px solid ${isSelected ? (config.primary_color || defaultConfig.primary_color) : 'transparent'};">
                      ${opt}
                    </button>
                  `;
                }).join('')}
              </div>
            `).join('')}
          </div>`;
      } else if (currentTab === 'cities') {
        content += `
          <div class="rounded-lg p-4 sm:p-6" style="background-color: ${config.card_color || defaultConfig.card_color}; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <h2 class="font-bold mb-3 sm:mb-4" style="font-size: ${baseSize * 1.3}px;">Famous Cities & Their Specialties</h2>
            <div class="mobile-city-grid">
              ${citiesData.map((city, cityIdx) => `
                <div class="p-4 sm:p-6 rounded-lg" style="background-color: ${config.background_color || defaultConfig.background_color}; border: 2px solid ${config.primary_color || defaultConfig.primary_color};">
                  <div class="flex items-center mb-3">
                    <span style="font-size: ${baseSize * 1.8}px;" class="mr-2 sm:mr-3">${city.icon}</span>
                    <div class="flex-1">
                      <h3 class="font-bold flex flex-col sm:flex-row sm:items-center" style="font-size: ${baseSize * 1.1}px; color: ${config.primary_color || defaultConfig.primary_color};">
                        <span>${city.name}, ${city.country}</span>
                        <span class="mt-1 sm:mt-0 sm:ml-2" style="font-size: ${baseSize}px;">${city.flag}</span>
                      </h3>
                    </div>
                  </div>
                  <p class="mb-3 sm:mb-4 text-sm sm:text-base" style="font-size: ${baseSize * 0.85}px; line-height: 1.5;">${city.description}</p>
                  
                  <h4 class="font-semibold mb-2 sm:mb-3" style="font-size: ${baseSize * 0.9}px;">Famous Dishes:</h4>
                  <div class="space-y-1 sm:space-y-2">
                    ${city.dishes.map((dish, dishIdx) => `
                      <div class="mobile-dish-item" style="background-color: ${config.card_color || defaultConfig.card_color};">
                        <div class="mobile-dish-info">
                          <div class="flex items-center">
                            <span style="font-size: ${baseSize * 1.1}px;" class="mr-2 sm:mr-3">${dish.icon}</span>
                            <div>
                              <span class="font-semibold" style="font-size: ${baseSize * 0.9}px;">${dish.name}</span>
                              <span class="ml-1 sm:ml-2 text-gray-600 text-xs sm:text-sm" style="font-size: ${baseSize * 0.7}px;">/${dish.pronunciation}/</span>
                            </div>
                          </div>
                        </div>
                        <button onclick="speakDish('${dish.name}')" 
                          class="mobile-dish-button px-2 sm:px-3 py-1 rounded transition-colors text-xs sm:text-sm" 
                          style="background-color: ${config.accent_color || defaultConfig.accent_color}; color: white; font-size: ${baseSize * 0.7}px;">
                          🔊 Nghe
                        </button>
                      </div>
                    `).join('')}
                  </div>
                </div>
              `).join('')}
            </div>
          </div>`;
      } else if (currentTab === 'grammar') {
        content += `
          <div class="rounded-lg p-4 sm:p-6" style="background-color: ${config.card_color || defaultConfig.card_color}; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <h2 class="font-bold mb-3 sm:mb-4" style="font-size: ${baseSize * 1.3}px;">Lý thuyết ngữ pháp</h2>
            <div class="space-y-2 sm:space-y-3 mb-4 sm:mb-6">
              ${grammarTopics.map((topic, idx) => `
                <button onclick="selectGrammarTopic(${idx})" 
                  class="w-full text-left p-3 sm:p-4 rounded-lg font-semibold transition-colors text-sm sm:text-base"
                  style="background-color: ${currentGrammarTopic === idx ? (config.primary_color || defaultConfig.primary_color) : config.background_color || defaultConfig.background_color}; 
                         color: ${currentGrammarTopic === idx ? 'white' : (config.text_color || defaultConfig.text_color)}; 
                         font-size: ${baseSize * 0.9}px;">
                  ${topic.title}
                </button>
              `).join('')}
              <button onclick="selectGrammarTopic('exercises')" 
                class="w-full text-left p-3 sm:p-4 rounded-lg font-semibold transition-colors text-sm sm:text-base"
                style="background-color: ${currentGrammarTopic === 'exercises' ? (config.accent_color || defaultConfig.accent_color) : config.background_color || defaultConfig.background_color}; 
                       color: ${currentGrammarTopic === 'exercises' ? 'white' : (config.text_color || defaultConfig.text_color)}; 
                       font-size: ${baseSize * 0.9}px;">
                Bài tập tổng hợp (30 câu)
              </button>
            </div>
            
            ${currentGrammarTopic !== null && currentGrammarTopic !== 'exercises' ? `
              <div class="p-4 sm:p-6 rounded-lg" style="background-color: ${config.background_color || defaultConfig.background_color}; font-size: ${baseSize * 0.9}px; line-height: 1.6;">
                ${grammarTopics[currentGrammarTopic].content}
              </div>
            ` : ''}
            
            ${currentGrammarTopic === 'exercises' ? `
              <div class="space-y-3 sm:space-y-4">
                <h3 class="font-bold mb-3 sm:mb-4" style="font-size: ${baseSize * 1.2}px;">Bài tập tổng hợp</h3>
                ${grammarExercises.map((ex, exIdx) => `
                  <div class="p-3 sm:p-4 rounded-lg" style="background-color: ${config.background_color || defaultConfig.background_color};">
                    <p class="font-semibold mb-2 sm:mb-3" style="font-size: ${baseSize * 0.9}px;">${exIdx + 1}. ${ex.question}</p>
                    ${ex.options.map((opt, optIdx) => {
                      const isSelected = currentExerciseAnswers[exIdx] === optIdx;
                      const isCorrect = optIdx === ex.correct;
                      const showResult = currentExerciseAnswers[exIdx] !== null;
                      let bgColor = config.card_color || defaultConfig.card_color;
                      if (showResult && isSelected && isCorrect) bgColor = config.accent_color || defaultConfig.accent_color;
                      if (showResult && isSelected && !isCorrect) bgColor = '#ef4444';
                      if (showResult && !isSelected && isCorrect) bgColor = config.accent_color || defaultConfig.accent_color;
                      
                      return `
                        <button onclick="checkGrammarAnswer(${exIdx}, ${optIdx})" 
                          class="w-full text-left p-2 sm:p-3 rounded mb-1 sm:mb-2 transition-colors text-sm sm:text-base"
                          style="background-color: ${bgColor}; 
                                 color: ${showResult && (isCorrect || isSelected) ? 'white' : (config.text_color || defaultConfig.text_color)}; 
                                 font-size: ${baseSize * 0.85}px;
                                 border: 2px solid ${isSelected ? (config.primary_color || defaultConfig.primary_color) : 'transparent'};">
                          ${opt}
                        </button>
                      `;
                    }).join('')}
                  </div>
                `).join('')}
              </div>
            ` : ''}
          </div>
        `;
      }
      
      content += `</div>`;
      app.innerHTML = content;
    }

    window.switchTab = function(tab) {
      currentTab = tab;
      render();
    };

    window.switchVocabularyMode = function(mode) {
      vocabularyMode = mode;
      render();
    };



    window.nextVocab = nextVocab;
    window.prevVocab = prevVocab;
    window.flipCard = flipCard;
    window.checkReadingAnswer = checkReadingAnswer;
    window.checkVocabQuizAnswer = checkVocabQuizAnswer;
    window.selectGrammarTopic = function(topicIdx) {
      currentGrammarTopic = topicIdx;
      render();
    };
    window.checkGrammarAnswer = checkGrammarAnswer;
    window.speakDish = speakDish;

    document.addEventListener('keydown', (e) => {
      if (currentTab === 'vocabulary') {
        if (e.key === 'ArrowRight') nextVocab();
        if (e.key === 'ArrowLeft') prevVocab();
        if (e.key === ' ') {
          e.preventDefault();
          flipCard();
        }
      }
    });

    async function onConfigChange(config) {
      render();
    }

    async function init() {
      if (window.dataSdk) {
        const initResult = await window.dataSdk.init(dataHandler);
        if (!initResult.isOk) {
          console.error("Failed to initialize data SDK");
        }
      }

      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange,
          mapToCapabilities: (config) => ({
            recolorables: [
              {
                get: () => config.background_color || defaultConfig.background_color,
                set: (value) => {
                  config.background_color = value;
                  window.elementSdk.setConfig({ background_color: value });
                }
              },
              {
                get: () => config.card_color || defaultConfig.card_color,
                set: (value) => {
                  config.card_color = value;
                  window.elementSdk.setConfig({ card_color: value });
                }
              },
              {
                get: () => config.text_color || defaultConfig.text_color,
                set: (value) => {
                  config.text_color = value;
                  window.elementSdk.setConfig({ text_color: value });
                }
              },
              {
                get: () => config.primary_color || defaultConfig.primary_color,
                set: (value) => {
                  config.primary_color = value;
                  window.elementSdk.setConfig({ primary_color: value });
                }
              },
              {
                get: () => config.accent_color || defaultConfig.accent_color,
                set: (value) => {
                  config.accent_color = value;
                  window.elementSdk.setConfig({ accent_color: value });
                }
              }
            ],
            borderables: [],
            fontEditable: {
              get: () => config.font_family || defaultConfig.font_family,
              set: (value) => {
                config.font_family = value;
                window.elementSdk.setConfig({ font_family: value });
              }
            },
            fontSizeable: {
              get: () => config.font_size || defaultConfig.font_size,
              set: (value) => {
                config.font_size = value;
                window.elementSdk.setConfig({ font_size: value });
              }
            }
          }),
          mapToEditPanelValues: (config) => new Map([
            ["unit_title", config.unit_title || defaultConfig.unit_title],
            ["vocabulary_tab", config.vocabulary_tab || defaultConfig.vocabulary_tab],
            ["reading_tab", config.reading_tab || defaultConfig.reading_tab],
            ["grammar_tab", config.grammar_tab || defaultConfig.grammar_tab]
          ])
        });
      }

      render();
      speakWord(vocabularyData[0].word);
    }

    init();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'997bba1341320d7e',t:'MTc2MjAwMzYxOC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
